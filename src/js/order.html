<script>

    $(function () {
        loadOrders();
    });


    function loadOrders() {

        $.getJSON('/api/orders', function (data) {

            $("#viewOrders tbody").html("");

            if (data.length <= 0) {

                $("#viewOrders").html(`
                <div class="alert alert-danger mt-3 ml-3 mr-3" role="alert">
                    <h4 class="alert-heading">Ops, sem comandas!</h4>
                    <p>Não encontramos comandas cadastradas! Espere novas comandas serem criadas/abertas.</p>
                </div>`
                );

            }

            data.forEach(element => {

                $("#viewOrders tbody").append(`
                        <tr>
                            <td>
                                <a href="#" data-tooltip="tooltip" data-placement="top" title="Ver Pedidos" onclick="loadViewRequestsModal(${element.idOrder});" class="btn btn-success btn-sm btn-circle btnViewOrder">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="#" data-tooltip="tooltip" data-placement="top" title="Encerrar Comanda" onclick="closeOrder(${element.idOrder});" class="btn btn-warning btn-sm btn-circle btnCloseOrder">
                                    <i class="fas fa-window-close"></i>
                                </a>
                            </td>
                            <td>${element.idOrder}</td>
                            <td>${element.desName}</td>
                            <td>
                                ${((element.vlStatus == 1) ? "<span class='badge badge-success'>CONCLUÍDO</span></td>" : "<span class='badge badge-danger'>EM ABERTO</span>")}
                            </td>
                            <td>R$ ${numberToShow(element.total)}</td>
                            <td>${element.dtRegister}</td>
                        </tr>
                    `);
            });

        }).then(() => {
            $('[data-tooltip="tooltip"]').tooltip();
            loadDataTables();

        }).fail(function () {
            console.log("Rota não encontrada!");
        });

    }

    function loadDataTables() {
        $('#viewOrders').DataTable({
            "pagingType": "full",
            "language": {
                "emptyTable": "Nenhum registro encontrado",
                "info": "Mostrando de _START_ até _END_ de _TOTAL_ registros",
                "infoEmpty": "Mostrando 0 até 0 de 0 registros",
                "infoFiltered": "(Filtrados de _MAX_ registros)",
                "infoPostFix": "",
                "infoThousands": ".",
                "lengthMenu": "_MENU_ resultados por página",
                "loadingRecords": "Carregando...",
                "processing": "Processando...",
                "zeroRecords": "Nenhum registro encontrado",
                "search": "Pesquisar:",
                "paginate": {
                    "next": "Próximo",
                    "previous": "Anterior",
                    "first": "Primeiro",
                    "last": "Último"
                },
                "aria": {
                    "sortAscending": ": Ordenar colunas de forma ascendente",
                    "sortDescending": ": Ordenar colunas de forma descendente"
                }
            }

        });
    }

    function loadViewRequestsModal(idOrder) {

        $.getJSON(`/api/requests/orders/${idOrder}`, function (data) {

            $("#viewRequests").html(" ");

            let contentViewRequest;

            data.forEach(element => {

                contentViewRequest = '<div class="card">';
                contentViewRequest += '<div class="card-header">';
                contentViewRequest += '<div class="float-left">';
                contentViewRequest += 'PEDIDO Nº ' + element.idRequest;
                contentViewRequest += '</div>';
                contentViewRequest += '<div class="float-right">R$ ' + numberToShow(element.total);
                contentViewRequest += '</div>';
                contentViewRequest += '</div>';
                contentViewRequest += '<div class="card-body">';
                contentViewRequest += '<div class="desRequest requestProducts" data-id="' + element.idRequest + '">';
                contentViewRequest += '</div>';

                if (element.desNote != null) {
                    contentViewRequest += '<p class="card-text">*' + element.desNote + '</p>';
                } else {
                    contentViewRequest += '<p class="card-text">* Pedido sem observações.</p>';
                }

                contentViewRequest += '</div>';
                contentViewRequest += '<div class="card-footer">';
                contentViewRequest += '<div class="float-left">';

                if (element.vlStatus == 1) {
                    contentViewRequest += "<span class='badge badge-success'>CONCLUÍDO</span></td>";
                } else {
                    contentViewRequest += "<span class='badge badge-danger'>EM ABERTO</span>";
                }

                contentViewRequest += '</div>';
                contentViewRequest += '<div class="float-right">';
                contentViewRequest += '<small><i class="fas fa-clock"></i> ' + element.dtRegister + '</small>';
                contentViewRequest += '</div>';
                contentViewRequest += '</div>';
                contentViewRequest += '</div>'
                contentViewRequest += '<br>';

                $("#viewRequests").append(contentViewRequest);

            });

            $("#modalViewOrders").modal("toggle");


        }).then(() => {

            loadRequestProducts();

        }).fail(function () {
            console.log("Rota não encontrada!");
        });

    }

    function closeOrder(idOrder) {

        $.post(`/api/close/order/${idOrder}`, function (data) {

            if (!JSON.parse(data).error) {
                swal("Tudo certo!", "Comanda fechada com sucesso!", "success");
            } else {
                swal("Ops!", JSON.parse(data).message, "error");
            }

        }).fail(() => {

            console.log("Rota não encontrada!");

        });

    }

    function loadRequestProducts() {

        $(".requestProducts").each(function (index) {

            let request = $(this);
            let price = 0;

            $.getJSON(`/api/requests/products/${request.data("id")}`, function (data) {

                data.forEach(element => {

                    price += element.qtProduct * element.vlUnity;
                    request.append(`<h5 class="card-title text-uppercase">(${element.qtProduct}) ${element.desName}</h5>`);

                });

                console.log(price);

            }).fail(() => {

                request.append(`
                    <div class="alert alert-danger" role="alert">
                    Não foi possível carregar os produtos!
                    </div>`
                );

            });

        });

    }

</script>